<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFST ç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f4f6f9; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        /* æ—¥å¿—åŒºåŸŸæ ·å¼ */
        #logs { 
            background: #1e1e1e; color: #a9b7c6; 
            height: 600px; /* ç¨å¾®è°ƒé«˜ä¸€ç‚¹ */
            overflow-y: scroll; 
            padding: 15px; font-family: 'Consolas', monospace; 
            font-size: 13px; line-height: 1.4;
            white-space: pre-wrap; 
        }
    </style>
</head>
<body>
<div class="container" style="max-width: 1400px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸš€ CFST è‡ªåŠ¨ä¼˜é€‰ (Docker)</h2>
        <div>
            <a href="https://github.com/XIU2/CloudflareSpeedTest/releases" target="_blank" class="btn btn-outline-primary btn-sm">GitHub Releases</a>
            <span class="badge bg-secondary ms-2" id="st_cfst_badge">CFST: æ£€æµ‹ä¸­</span>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-5">
            <div class="card mb-3">
                <div class="card-header fw-bold bg-white">1. æ ¸å¿ƒæ–‡ä»¶ä¸Šä¼ </div>
                <div class="card-body">
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">æ‰§è¡Œæ–‡ä»¶ (cfst)</span>
                        <input type="file" class="form-control" id="file_cfst">
                        <button class="btn btn-primary" onclick="upload('cfst')">ä¸Šä¼ </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">IPv4</span>
                                <input type="file" class="form-control" id="file_ip4">
                                <button class="btn btn-outline-secondary" onclick="upload('ip4')">ä¸Šä¼ </button>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">IPv6</span>
                                <input type="file" class="form-control" id="file_ip6">
                                <button class="btn btn-outline-secondary" onclick="upload('ip6')">ä¸Šä¼ </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header fw-bold bg-white">2. å‚æ•°é…ç½®</div>
                <div class="card-body">
                    <form action="/api/save" method="post">
                        <h6 class="text-muted mb-2">Cloudflare API</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><input type="email" class="form-control form-control-sm" name="email" value="{{.Email}}" placeholder="Email" required></div>
                            <div class="col-6"><input type="password" class="form-control form-control-sm" name="api_key" value="{{.APIKey}}" placeholder="Global API Key" required></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="zone_id" value="{{.ZoneID}}" placeholder="Zone ID" required></div>
                        </div>

                        <h6 class="text-muted mb-2">åŸŸåè§£æ (æ”¯æŒå¤šåŸŸå)</h6>
                        <div class="mb-3">
                            <input type="text" class="form-control" name="domains" value="{{.Domains}}" placeholder="ä¾‹å¦‚: speed.abc.com, cdn.abc.com" required>
                            <div class="form-text small">
                                æ¨¡å¼é€»è¾‘ï¼š<br>
                                1. <b>å•åŸŸå</b>ï¼šè§£æé€Ÿåº¦æœ€å¿«çš„ <b>Top N</b> ä¸ª IP åˆ°è¯¥åŸŸå (è´Ÿè½½å‡è¡¡)ã€‚<br>
                                2. <b>å¤šåŸŸå</b> (é€—å·éš”å¼€)ï¼š<b>1å¯¹1 æ˜ å°„</b>ã€‚ç¬¬1å¿«çš„IP -> åŸŸå1ï¼Œç¬¬2å¿« -> åŸŸå2ã€‚
                            </div>
                        </div>

                        <h6 class="text-muted mb-2">æµ‹é€Ÿå‚æ•°</h6>
                        
                        <div class="mb-2">
                            <label class="small text-muted">è‡ªå®šä¹‰æµ‹é€Ÿåœ°å€ (-url)</label>
                            <input type="text" class="form-control form-control-sm" name="download_url" value="{{.DownloadURL}}" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤ (200MB)">
                            <div class="form-text small" style="margin-top:0;">å¯å¡«å…¥è‡ªå»ºçš„å¤§æ–‡ä»¶ä¸‹è½½é“¾æ¥ï¼Œä¸ºç©ºåˆ™ä½¿ç”¨ Cloudflare å®˜æ–¹é»˜è®¤åœ°å€ã€‚</div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-12">
                                <div class="btn-group w-100 btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="ip_type" id="v4" value="v4" {{if eq .IPType "v4"}}checked{{end}} {{if eq .IPType ""}}checked{{end}}>
                                    <label class="btn btn-outline-primary" for="v4">ä»… IPv4</label>
                                    <input type="radio" class="btn-check" name="ip_type" id="v6" value="v6" {{if eq .IPType "v6"}}checked{{end}}>
                                    <label class="btn btn-outline-primary" for="v6">ä»… IPv6</label>
                                    <input type="radio" class="btn-check" name="ip_type" id="both" value="both" {{if eq .IPType "both"}}checked{{end}}>
                                    <label class="btn btn-outline-primary" for="both">v4+v6 æ··åˆ</label>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="small text-muted">å•åŸŸåè§£ææ•° (é»˜è®¤10)</label>
                                <input type="number" class="form-control form-control-sm" name="max_result" value="{{.MaxResult}}">
                            </div>
                             <div class="col-6">
                                <label class="small text-muted">æµ‹é€Ÿæ•°é‡ (-dn)</label>
                                <input type="number" class="form-control form-control-sm" name="test_count" value="{{.TestCount}}">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">åœ°åŒºç  (å¦‚ HKG)</label>
                                <input type="text" class="form-control form-control-sm" name="colo" value="{{.Colo}}">
                            </div>
                            <div class="col-6 d-flex align-items-end">
                                <div class="form-check form-switch mb-1">
                                    <input class="form-check-input" type="checkbox" name="enable_httping" id="httping" {{if .EnableHTTPing}}checked{{end}}>
                                    <label class="form-check-label small" for="httping">HTTPing</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="small text-muted">Cron è®¡åˆ’</label>
                            <input type="text" class="form-control form-control-sm" name="cron_spec" value="{{.CronSpec}}">
                        </div>

                        <button type="submit" class="btn btn-success w-100">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span>ğŸ“º å®æ—¶åŠ¨æ€æ—¥å¿—</span>
                    <button onclick="runNow()" class="btn btn-sm btn-warning">âš¡ ç«‹å³æµ‹é€Ÿ</button>
                </div>
                <div class="card-body p-0 bg-dark">
                    <div id="logs"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let logOffset = 0;
    const logsDiv = document.getElementById('logs');

    // å¢é‡è·å–æ—¥å¿—
    function fetchLogs() {
        fetch('/api/logs?offset=' + logOffset)
            .then(r => r.json())
            .then(data => {
                if (data.log) {
                    logsDiv.textContent += data.log;
                    logOffset = data.offset;
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                }
            })
            .catch(e => console.log("æ—¥å¿—è½®è¯¢...", e));
    }

    // æ¯ç§’è½®è¯¢ä¸€æ¬¡
    setInterval(fetchLogs, 1000);

    function runNow() {
        if(confirm("ç¡®å®šç«‹å³è¿è¡Œæµ‹é€Ÿå—ï¼Ÿå¯èƒ½è€—æ—¶è¾ƒé•¿ã€‚")) {
            fetch('/api/run').then(r=>r.text()).then(alert);
        }
    }

    function upload(type) {
        const input = document.getElementById('file_' + type);
        if (!input.files[0]) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
        const fd = new FormData();
        fd.append("file", input.files[0]);
        fd.append("type", type);
        
        // ç®€å•çš„ Loading æç¤º
        const btn = event.target;
        const orgText = btn.innerText;
        btn.innerText = "ä¸Šä¼ ä¸­...";
        btn.disabled = true;

        fetch('/api/upload', {method:'POST', body:fd}).then(r=>{
            if(r.ok) { 
                alert("ä¸Šä¼ æˆåŠŸ"); 
                checkStatus(); 
            } else {
                alert("ä¸Šä¼ å¤±è´¥");
            }
            btn.innerText = orgText;
            btn.disabled = false;
        });
    }

    function checkStatus() {
        fetch('/api/status').then(r=>r.json()).then(d => {
            const el = document.getElementById('st_cfst_badge');
            el.className = d.has_cfst ? "badge bg-success" : "badge bg-danger";
            el.innerText = d.has_cfst ? "CFST: å·²å®‰è£…" : "CFST: æœªä¸Šä¼ ";
        });
    }
    checkStatus();
</script>
</body>
</html>
